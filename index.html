<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Firebase ä¸²æŽ¥æ¸¬è©¦</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding-top: 50px; background: #f0f2f5; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; width: 300px; }
        .count { font-size: 4rem; color: #4285F4; margin: 20px 0; }
        button { width: 100%; padding: 12px; margin: 5px 0; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; }
        .btn-plus { background: #4285F4; color: white; font-size: 1.2rem; }
        .btn-google { background: #fff; color: #757575; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; }
        .btn-logout { background: #eee; color: #555; font-size: 0.8rem; }
        #statusText { margin-top: 15px; font-size: 0.85rem; color: #666; }
    </style>
</head>
<body>

    <div class="card">
        <div id="statusText">è¼‰å…¥ä¸­...</div>
        <div class="count" id="counterDisplay">0</div>
        <button class="btn-plus" onclick="increment()">é»žæ“Š +1</button>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        <div id="authArea">
            <button class="btn-google" id="loginBtn" onclick="toggleAuth()">ä½¿ç”¨ Google ç™»å…¥</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- è«‹åœ¨æ­¤è™•è²¼ä¸Šä½ çš„ Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAbHsSUxi1NLAo2rcblzHyZFZ0D-aUSO3E",
            authDomain: "counter-test-af5d4.firebaseapp.com",
            projectId: "counter-test-af5d4",
            storageBucket: "counter-test-af5d4.firebasestorage.app",
            messagingSenderId: "1029584333400",
            appId: "1:1029584333400:web:f8bbd78144dfb1421d382d",
            measurementId: "G-7HLKWPHVJT"
        };

        // åˆå§‹åŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let count = parseInt(localStorage.getItem('my_test_count')) || 0;
        
        const display = document.getElementById('counterDisplay');
        const statusText = document.getElementById('statusText');
        const loginBtn = document.getElementById('loginBtn');

        display.innerText = count;

        // ç›£è½ç™»å…¥ç‹€æ…‹
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                statusText.innerText = `ðŸ‘‹ ä½ å¥½ï¼Œ${user.displayName}`;
                loginBtn.innerText = "ç™»å‡ºå¸³è™Ÿ";
                loginBtn.className = "btn-logout";
                
                // å˜—è©¦å¾ž Firestore æŠ“å–è³‡æ–™
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    count = docSnap.data().count;
                    updateUI();
                } else {
                    syncToCloud(); // é›²ç«¯æ²’è³‡æ–™å°±å‚³ä¸ŠåŽ»
                }
            } else {
                currentUser = null;
                statusText.innerText = "ç›®å‰ç‚ºé›¢ç·šç‹€æ…‹ (LocalStorage)";
                loginBtn.innerText = "ä½¿ç”¨ Google ç™»å…¥";
                loginBtn.className = "btn-google";
            }
        });

        // å¢žåŠ è¨ˆæ•¸
        window.increment = () => {
            count++;
            updateUI();
            localStorage.setItem('my_test_count', count);
            if (currentUser) syncToCloud();
        };

        // ç™»å…¥ç™»å‡ºåˆ‡æ›
        window.toggleAuth = () => {
            if (!currentUser) {
                signInWithPopup(auth, provider).catch(err => alert("ç™»å…¥å¤±æ•—: " + err.message));
            } else {
                signOut(auth);
            }
        };

        function updateUI() {
            display.innerText = count;
        }

        async function syncToCloud() {
            if (currentUser) {
                await setDoc(doc(db, "users", currentUser.uid), { count: count });
            }
        }
    </script>
</body>
</html>